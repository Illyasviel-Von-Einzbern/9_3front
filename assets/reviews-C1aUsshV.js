import{ab as J,r as s,v as K,y as Q,e as P,w as a,o as T,c as o,f as w,ai as L,V as c,i as r,ac as S,ae as x,ad as W,an as X,aj as Y,ak as Z,al as ee,ap as te,j as le}from"./index-AWgwsy0c.js";import{r as ae}from"./restaurant-wEHn5vvw.js";import{r as p}from"./review-CkcIbMSl.js";import{b as h}from"./route-block-B_A1xBdJ.js";import{V as oe}from"./VContainer-DdjiTbVz.js";import{V as ne,a as C}from"./VRow-DgrlSwcS.js";import{V as A}from"./VSelect-C4kuFK5Q.js";import{V as se}from"./VDataTable-BWFFZXyR.js";import{V as re}from"./VChip-BXeRU_1z.js";import{V as $}from"./VRating-Crk21thQ.js";import{a as ie}from"./VToolbar-BlAZ4Cry.js";import"./VList-Dn2VOZxI.js";import"./VDivider-DMIPa6pT.js";import"./VMenu-DoDXjbwU.js";import"./VCheckboxBtn-DDuY08wn.js";import"./VPagination-DoiRKGmI.js";import"./filter-C9uyxmCX.js";const ue=["innerHTML"],de=["innerHTML"],ce=["innerHTML"],me={__name:"reviews",setup(ve){const n=J(),k=s([]),i=s(""),M=[{text:"全部",value:null},{text:"匿名評論",value:"anonymous"},{text:"已刪除",value:"deleted"}],y=s(null),D=s([]),g=s(null),m=s([]),f=s(new Set),U=[{title:"評論內容",key:"content"},{title:"評分",key:"score"},{title:"評論者",key:"user.account"},{title:"餐廳",key:"restaurant.name"},{title:"時間",key:"createdAt"},{title:"狀態",key:"isDeleted"},{title:"操作",key:"action",sortable:!1}],H=async()=>{var l;try{const{data:e}=await ae.getAll();D.value=((l=e==null?void 0:e.result)==null?void 0:l.map(t=>({text:t.name,value:t._id})))||[]}catch{n({text:"無法取得餐廳列表",snackbarProps:{color:"red"}})}},v=async()=>{try{const{data:l}=await p.getAllAdmin();console.log("API回傳資料:",l),k.value=(l==null?void 0:l.result)||[],console.log("reviews",k.value)}catch{n({text:"無法取得評論列表",snackbarProps:{color:"red"}})}},B=K(()=>{let l=[...k.value];if(y.value==="anonymous"?l=l.filter(e=>e.isAnonymous):y.value==="deleted"&&(l=l.filter(e=>e.isDeleted)),g.value&&(l=l.filter(e=>String(e.restaurant._id)===String(g.value))),i.value){const e=i.value.toLowerCase();l=l.filter(t=>{var d,R;return t.content&&t.content.toLowerCase().includes(e)||((d=t.user)==null?void 0:d.account)&&t.user.account.toLowerCase().includes(e)||((R=t.restaurant)==null?void 0:R.name)&&t.restaurant.name.toLowerCase().includes(e)})}return l}),I=async()=>{if(m.value.length!==0)try{await Promise.all(m.value.map(l=>p.delete(l))),n({text:"批次刪除成功",snackbarProps:{color:"green"}}),m.value=[],await v()}catch{n({text:"批次刪除失敗",snackbarProps:{color:"red"}})}},N=l=>{f.value.has(l)?f.value.delete(l):f.value.add(l)},E=(l,e)=>f.value.has(e)?l:l.length>100?l.slice(0,100)+"...":l,b=(l,e)=>{if(!e)return l;const t=e.replace(/[-/\\^$*+?.()|[\]{}]/g,String.raw`\$&`),d=new RegExp(`(${t})`,"gi");return l.replace(d,'<span style="background-color: yellow;">$1</span>')},V=s(!1),u=s({content:"",score:0}),_=s(!1),j=l=>{u.value={...l},V.value=!0},z=async()=>{_.value=!0;try{await p.update(u.value._id,{content:u.value.content,score:u.value.score}),n({text:"更新成功",snackbarProps:{color:"green"}}),V.value=!1,await v()}catch{n({text:"更新失敗",snackbarProps:{color:"red"}})}finally{_.value=!1}},F=async l=>{try{await p.softDelete(l),n({text:"已軟刪除",snackbarProps:{color:"orange"}}),await v()}catch{n({text:"操作失敗",snackbarProps:{color:"red"}})}},O=async l=>{try{await p.restore(l),n({text:"已恢復",snackbarProps:{color:"green"}}),await v()}catch{n({text:"操作失敗",snackbarProps:{color:"red"}})}},q=async(l,e)=>{await(e?O(l):F(l))},G=async l=>{if(confirm("確定要永久刪除這則評論嗎？"))try{await p.delete(l),n({text:"已永久刪除",snackbarProps:{color:"red"}}),await v()}catch{n({text:"刪除失敗",snackbarProps:{color:"red"}})}};return Q(()=>{v(),H()}),(l,e)=>(T(),P(oe,{fluid:""},{default:a(()=>[o(ne,null,{default:a(()=>[o(C,{cols:"12"},{default:a(()=>e[8]||(e[8]=[w("h1",{class:"text-center"},"評論管理",-1)])),_:1,__:[8]}),o(C,{class:"d-flex align-center mb-4",cols:"12",gap:"16"},{default:a(()=>[o(L,{modelValue:i.value,"onUpdate:modelValue":e[0]||(e[0]=t=>i.value=t),density:"compact","hide-details":"",placeholder:"搜尋評論 / 評論者 / 餐廳","prepend-inner-icon":"mdi-magnify",style:{"max-width":"350px"},variant:"solo"},null,8,["modelValue"]),o(A,{modelValue:y.value,"onUpdate:modelValue":e[1]||(e[1]=t=>y.value=t),clearable:"",dense:"","item-title":"text","item-value":"value",items:M,label:"篩選",style:{"max-width":"150px"}},null,8,["modelValue"]),o(A,{modelValue:g.value,"onUpdate:modelValue":e[2]||(e[2]=t=>g.value=t),clearable:"",dense:"","item-title":"text","item-value":"value",items:D.value,label:"篩選餐廳",style:{"max-width":"200px"}},null,8,["modelValue","items"]),o(c,{color:"error",disabled:m.value.length===0,onClick:I},{default:a(()=>e[9]||(e[9]=[r(" 批次刪除 ",-1)])),_:1,__:[9]},8,["disabled"])]),_:1}),o(C,{cols:"12"},{default:a(()=>[o(se,{selected:m.value,"onUpdate:selected":e[3]||(e[3]=t=>m.value=t),class:"elevation-1",headers:U,"item-key":"_id",items:B.value,search:i.value,"show-select":""},{top:a(()=>[o(ie,{flat:""})]),"item.content":a(({item:t})=>[w("div",null,[w("span",{innerHTML:b(E(t.content,t._id),i.value)},null,8,ue),t.content.length>100?(T(),P(c,{key:0,small:"",text:"",onClick:d=>N(t._id)},{default:a(()=>[r(x(f.value.has(t._id)?"收合":"展開"),1)]),_:2},1032,["onClick"])):W("",!0)])]),"item.score":a(({value:t})=>[o($,{dense:"","model-value":t,readonly:"",size:"small"},null,8,["model-value"])]),"item.user.account":a(({item:t})=>[w("span",{innerHTML:b(t.user.account||"匿名",i.value)},null,8,de)]),"item.restaurant.name":a(({item:t})=>[w("span",{innerHTML:b(t.restaurant.name,i.value)},null,8,ce)]),"item.createdAt":a(({item:t})=>[r(x(new Date(t.createdAt).toLocaleString()),1)]),"item.isDeleted":a(({value:t})=>[o(re,{color:t?"error":"success",size:"small",variant:"outlined"},{default:a(()=>[r(x(t?"已刪除":"正常"),1)]),_:2},1032,["color"])]),"item.action":a(({item:t})=>[o(c,{color:"blue",icon:"",onClick:d=>j(t)},{default:a(()=>[o(S,null,{default:a(()=>e[10]||(e[10]=[r("mdi-pencil",-1)])),_:1,__:[10]})]),_:2},1032,["onClick"]),o(c,{class:"me-2",color:t.isDeleted?"success":"error",small:"",title:t.isDeleted?"恢復":"軟刪除",onClick:d=>q(t._id,t.isDeleted)},{default:a(()=>[r(x(t.isDeleted?"恢復":"軟刪除"),1)]),_:2},1032,["color","title","onClick"]),o(c,{color:"red",icon:"",title:"永久刪除",onClick:d=>G(t._id)},{default:a(()=>[o(S,null,{default:a(()=>e[11]||(e[11]=[r("mdi-delete",-1)])),_:1,__:[11]})]),_:2},1032,["onClick"])]),_:2},1032,["selected","items","search"])]),_:1}),o(X,{modelValue:V.value,"onUpdate:modelValue":e[7]||(e[7]=t=>V.value=t),"max-width":"500"},{default:a(()=>[o(Y,null,{default:a(()=>[o(Z,null,{default:a(()=>e[12]||(e[12]=[r("編輯評論",-1)])),_:1,__:[12]}),o(ee,null,{default:a(()=>[o(L,{modelValue:u.value.content,"onUpdate:modelValue":e[4]||(e[4]=t=>u.value.content=t),label:"評論內容"},null,8,["modelValue"]),o($,{modelValue:u.value.score,"onUpdate:modelValue":e[5]||(e[5]=t=>u.value.score=t),label:"評分"},null,8,["modelValue"])]),_:1}),o(te,null,{default:a(()=>[o(le),o(c,{text:"",onClick:e[6]||(e[6]=t=>V.value=!1)},{default:a(()=>e[13]||(e[13]=[r("取消",-1)])),_:1,__:[13]}),o(c,{color:"primary",loading:_.value,onClick:z},{default:a(()=>e[14]||(e[14]=[r("保存",-1)])),_:1,__:[14]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}))}};typeof h=="function"&&h(me);export{me as default};
