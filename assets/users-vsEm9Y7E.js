import{ab as O,r as u,y as P,v as Q,e as $,w as o,ag as b,o as A,c as a,f as S,aj as T,ak as q,i as r,ao as W,ad as X,ai as k,V as m,ae as f,ac as N,an as Y,al as Z,ap as h,j as ee}from"./index-AWgwsy0c.js";import{b as F}from"./route-block-B_A1xBdJ.js";import{V as le}from"./VContainer-DdjiTbVz.js";import{a as v,V as ae}from"./VRow-DgrlSwcS.js";import{V as oe}from"./VForm-BiP2f0f4.js";import{V as L}from"./VSelect-C4kuFK5Q.js";import{V as j}from"./VCheckbox-DO8XisfU.js";import{V as te}from"./VAlert-tqLe5aL3.js";import{V as se}from"./VDataTable-BWFFZXyR.js";import{V as E}from"./VChip-BXeRU_1z.js";import"./VList-Dn2VOZxI.js";import"./VDivider-DMIPa6pT.js";import"./VMenu-DoDXjbwU.js";import"./VCheckboxBtn-DDuY08wn.js";import"./VPagination-DoiRKGmI.js";import"./filter-C9uyxmCX.js";const re={class:"text-caption mt-2 text-right"},de={__name:"users",setup(ue){const d=O(),U=u([]),w=u(""),x=u(!1),p=u(""),n=u(null),g=u(!1),s=u({account:"",password:"",grade:"",role:"user",isBlocked:!1,isDeleted:!1}),I=["user","admin"],M=[{title:"帳號",value:"account"},{title:"年級",value:"grade"},{title:"身分",value:"role"},{title:"封鎖",value:"isBlocked"},{title:"刪除",value:"isDeleted"},{title:"建立時間",value:"createdAt"},{title:"操作",value:"actions",sortable:!1}],i=u(null),y=u(!1),C=u(!1),R=async()=>{try{const t=await b.profile();p.value=t.data.user._id}catch{d({text:"無法取得登入資訊",snackbarProps:{color:"red"}})}},V=async()=>{x.value=!0;try{const t=await b.getAll();console.log("取得的資料",t.data),U.value=t.data.result}catch{d({text:"無法取得使用者資料",snackbarProps:{color:"red"}}),console.error("fetchUsers error:",error)}finally{x.value=!1}};P(async()=>{await R(),await V()});const z=async()=>{if(i.value=null,!s.value.account||!s.value.password||!s.value.grade){i.value="帳號、密碼及年級為必填欄位";return}y.value=!0;try{const t=await b.adminCreate(s.value);t.data.success?(d({text:"新增成功",snackbarProps:{color:"green"}}),s.value={account:"",password:"",grade:"",role:"user",isBlocked:!1,isDeleted:!1},await V()):i.value=t.data.message||"新增失敗"}catch(t){console.error(t),i.value="伺服器錯誤"}finally{y.value=!1}},G=async t=>{if(t===p.value){d({text:"不能刪除自己",snackbarProps:{color:"orange"}});return}if(confirm("確定要刪除這位使用者嗎？"))try{await b.delete(t),d({text:"刪除成功",snackbarProps:{color:"green"}}),await V()}catch{d({text:"刪除失敗",snackbarProps:{color:"red"}})}},H=t=>{n.value={...t},g.value=!0},J=async()=>{try{await b.update(n.value._id,n.value),d({text:"更新成功",snackbarProps:{color:"green"}}),g.value=!1,await V()}catch{d({text:"更新失敗",snackbarProps:{color:"red"}})}finally{C.value=!1}},_=async(t,l,e)=>{if(t===p.value){d({text:"不能操作自己",snackbarProps:{color:"orange"}});return}try{const c={[l]:!e},D=await b.update(t,c);D.data.success?(d({text:`${l==="isBlocked"?"封鎖":"刪除"}狀態已更新`,snackbarProps:{color:"green"}}),await V()):d({text:D.data.message||"更新失敗",snackbarProps:{color:"red"}})}catch(c){console.error(c),d({text:"伺服器錯誤",snackbarProps:{color:"red"}})}},B=Q(()=>U.value.filter(t=>t.account.toLowerCase().includes(w.value.toLowerCase()))),K=t=>t?new Date(t).toLocaleString():"-";return P(V),(t,l)=>(A(),$(le,null,{default:o(()=>[a(v,{cols:"12"},{default:o(()=>l[13]||(l[13]=[S("h1",{class:"text-center"},"使用者管理",-1)])),_:1,__:[13]}),a(T,{class:"pa-4 mb-6"},{default:o(()=>[a(q,null,{default:o(()=>l[14]||(l[14]=[r("管理員新增使用者",-1)])),_:1,__:[14]}),a(oe,{ref:"formRef",onSubmit:W(z,["prevent"])},{default:o(()=>[a(ae,null,{default:o(()=>[a(v,{cols:"12",md:"4",sm:"6"},{default:o(()=>[a(k,{modelValue:s.value.account,"onUpdate:modelValue":l[0]||(l[0]=e=>s.value.account=e),clearable:"",label:"帳號",required:""},null,8,["modelValue"])]),_:1}),a(v,{cols:"12",md:"4",sm:"6"},{default:o(()=>[a(k,{modelValue:s.value.password,"onUpdate:modelValue":l[1]||(l[1]=e=>s.value.password=e),clearable:"",label:"密碼",required:"",type:"password"},null,8,["modelValue"])]),_:1}),a(v,{cols:"12",md:"4",sm:"6"},{default:o(()=>[a(k,{modelValue:s.value.grade,"onUpdate:modelValue":l[2]||(l[2]=e=>s.value.grade=e),clearable:"",label:"年級",required:""},null,8,["modelValue"])]),_:1}),a(v,{cols:"12",md:"4",sm:"6"},{default:o(()=>[a(L,{modelValue:s.value.role,"onUpdate:modelValue":l[3]||(l[3]=e=>s.value.role=e),clearable:"",items:I,label:"身分",required:""},null,8,["modelValue"])]),_:1}),a(v,{class:"d-flex align-center",cols:"12",md:"4",sm:"6"},{default:o(()=>[a(j,{modelValue:s.value.isBlocked,"onUpdate:modelValue":l[4]||(l[4]=e=>s.value.isBlocked=e),class:"me-4",label:"封鎖"},null,8,["modelValue"]),a(j,{modelValue:s.value.isDeleted,"onUpdate:modelValue":l[5]||(l[5]=e=>s.value.isDeleted=e),label:"刪除（軟刪除）"},null,8,["modelValue"])]),_:1}),a(v,{class:"d-flex align-center",cols:"12",md:"4",sm:"6"},{default:o(()=>[a(m,{color:"primary",disabled:y.value,loading:y.value,type:"submit"},{default:o(()=>l[15]||(l[15]=[r(" 新增使用者 ",-1)])),_:1,__:[15]},8,["disabled","loading"])]),_:1})]),_:1}),i.value?(A(),$(te,{key:0,class:"mt-3",dense:"",dismissible:"",type:"error","onClick:close":l[6]||(l[6]=e=>i.value=null)},{default:o(()=>[r(f(i.value),1)]),_:1})):X("",!0)]),_:1},512)]),_:1}),a(k,{modelValue:w.value,"onUpdate:modelValue":l[7]||(l[7]=e=>w.value=e),class:"mb-4",clearable:"",label:"搜尋帳號","prepend-icon":"mdi-magnify"},null,8,["modelValue"]),a(se,{class:"elevation-1",headers:M,"item-key":"id",items:B.value,loading:x.value,"sort-by":[{key:"account",order:"asc"}]},{"item.createdAt":o(({item:e})=>[r(f(K(e.createdAt)),1)]),"item.isBlocked":o(({item:e})=>[a(E,{color:e.isBlocked?"red":"green",dark:""},{default:o(()=>[r(f(e.isBlocked?"是":"否"),1)]),_:2},1032,["color"])]),"item.isDeleted":o(({item:e})=>[a(E,{color:e.isDeleted?"red":"green",dark:""},{default:o(()=>[r(f(e.isDeleted?"是":"否"),1)]),_:2},1032,["color"])]),"item.actions":o(({item:e})=>[a(m,{color:"blue",icon:"",onClick:c=>H(e)},{default:o(()=>[a(N,null,{default:o(()=>l[16]||(l[16]=[r("mdi-pencil",-1)])),_:1,__:[16]})]),_:2},1032,["onClick"]),a(m,{class:"me-2",color:e.isBlocked?"success":"error",disabled:e._id===p.value,small:"",title:e.isBlocked?"解除封鎖":"封鎖",onClick:c=>_(e._id,"isBlocked",e.isBlocked)},{default:o(()=>[r(f(e.isBlocked?"解除封鎖":"封鎖"),1)]),_:2},1032,["color","disabled","title","onClick"]),a(m,{class:"me-2",color:e.isDeleted?"success":"error",disabled:e._id===p.value,small:"",title:e.isDeleted?"復原":"刪除（軟刪除）",onClick:c=>_(e._id,"isDeleted",e.isDeleted)},{default:o(()=>[r(f(e.isDeleted?"復原":"刪除"),1)]),_:2},1032,["color","disabled","title","onClick"]),a(m,{color:"red",disabled:e._id===p.value,icon:"",title:"永久刪除",onClick:c=>G(e._id)},{default:o(()=>[a(N,null,{default:o(()=>l[17]||(l[17]=[r("mdi-delete",-1)])),_:1,__:[17]})]),_:2},1032,["disabled","onClick"])]),_:1},8,["items","loading"]),a(Y,{modelValue:g.value,"onUpdate:modelValue":l[12]||(l[12]=e=>g.value=e),"max-width":"500"},{default:o(()=>[a(T,null,{default:o(()=>[a(q,null,{default:o(()=>l[18]||(l[18]=[r("編輯使用者",-1)])),_:1,__:[18]}),a(Z,null,{default:o(()=>[a(k,{modelValue:n.value.account,"onUpdate:modelValue":l[8]||(l[8]=e=>n.value.account=e),disabled:"",label:"帳號"},null,8,["modelValue"]),a(k,{modelValue:n.value.grade,"onUpdate:modelValue":l[9]||(l[9]=e=>n.value.grade=e),label:"年級"},null,8,["modelValue"]),a(L,{modelValue:n.value.role,"onUpdate:modelValue":l[10]||(l[10]=e=>n.value.role=e),items:["user","admin"],label:"身分"},null,8,["modelValue"])]),_:1}),a(h,null,{default:o(()=>[a(ee),a(m,{text:"",onClick:l[11]||(l[11]=e=>g.value=!1)},{default:o(()=>l[19]||(l[19]=[r("取消",-1)])),_:1,__:[19]}),a(m,{color:"primary",disabled:C.value,loading:C.value,onClick:J},{default:o(()=>l[20]||(l[20]=[r("保存",-1)])),_:1,__:[20]},8,["disabled","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),S("div",re," 共 "+f(B.value.length)+" 位使用者 ",1)]),_:1}))}};typeof F=="function"&&F(de);export{de as default};
