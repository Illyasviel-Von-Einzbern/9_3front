import{_ as Z,ab as h,r as c,bk as ee,y as le,z as ae,e as U,w as t,b as oe,o as p,c as o,f as V,ao as se,aj as te,ak as ue,i as m,al as re,ad as ne,q as f,ai as i,ar as de,V as v,F as J,s as M,ac as B,ap as ie,j as me,h as pe,ah as ve}from"./index-AWgwsy0c.js";import{u as x,w as ce,r as Ve}from"./xlsx-DFGycjb8.js";import{r as E}from"./restaurant-wEHn5vvw.js";import{t as fe}from"./tag-Bne-C16A.js";import{V as ye}from"./VContainer-DdjiTbVz.js";import{V as y,a as d}from"./VRow-DgrlSwcS.js";import{V as be}from"./VForm-BiP2f0f4.js";import{V as C}from"./VFileInput-Cl5Qo54s.js";import{V as j}from"./VSelect-C4kuFK5Q.js";import{V as ge}from"./VCombobox-BQXtuI6i.js";import{V as D}from"./VSwitch-XuN0X4bQ.js";import{V as I}from"./VDivider-DMIPa6pT.js";import{V as _e}from"./VCheckbox-DO8XisfU.js";import{V as ke}from"./VTextarea-BSCHayHy.js";import"./VChip-BXeRU_1z.js";import"./VList-Dn2VOZxI.js";import"./VMenu-DoDXjbwU.js";import"./VCheckboxBtn-DDuY08wn.js";import"./filter-C9uyxmCX.js";const Ue={class:"mb-4"},xe={key:0},Ce={key:1},Se={__name:"[id]",setup(we){const z=ee(),P=oe(),S=h(),w=c(!0),A=c(!1),O=c([]),b=c(null),g=c(null),N=c(""),F=c(!1),a=c({name:"",phone:"",address:"",link:"",category:"",tags:[],delivery:!1,delivery_price:0,delivery_number:0,order_time:"",sell:!0,menu:[],business_hours:[],image:[]}),T={required:s=>!!s||"此欄位為必填"},_=z.params.id,q=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],W=[{title:"星期一",value:"Mon"},{title:"星期二",value:"Tue"},{title:"星期三",value:"Wed"},{title:"星期四",value:"Thu"},{title:"星期五",value:"Fri"},{title:"星期六",value:"Sat"},{title:"星期日",value:"Sun"}];le(async()=>{try{const{data:s}=await fe.getDefaultTags();s&&Array.isArray(s)?O.value=s.map(l=>l.name):(console.warn("從 API 收到的標籤資料格式不正確或為空"),O.value=[]);const{data:e}=await E.getById(_);if(e&&e.data){const l=e.data;a.value.name=l.name||"",a.value.phone=l.phone||"",a.value.address=l.address||"",a.value.link=l.link||"",a.value.category=l.category||"",a.value.delivery=l.delivery||!1,a.value.delivery_price=l.delivery_price||0,a.value.delivery_number=l.delivery_number||0,a.value.order_time=l.order_time||"",a.value.sell=l.sell??!0,a.value.tags=Array.isArray(l.tags)?l.tags.map(u=>u.name):[],a.value.menu=Array.isArray(l.menu)?l.menu.map(u=>({name:u.name,price:u.price,description:u.description||"",image:null})):[];const r=l.business_hours||[];a.value.business_hours=q.map(u=>r.find(k=>k.day===u)||{day:u,open:"",close:"",isClosed:!0})}else throw new Error("從 API 收到的餐廳資料格式不正確")}catch(s){console.error("載入餐廳資料失敗",s),S({text:"載入餐廳資料失敗",snackbarProps:{color:"error"}})}finally{w.value=!1}});const $=()=>{a.value.menu.push({name:"",price:null,description:"",image:null})},G=s=>{a.value.menu.splice(s,1)},R=()=>{for(const s of a.value.business_hours)s.isClosed=!1,s.open="09:00",s.close="18:00"},L=()=>{for(const s of a.value.business_hours){const e=s.day==="Sat"||s.day==="Sun";s.isClosed=e,e||(s.open="09:00",s.close="18:00")}},H=()=>{for(const s of a.value.business_hours)s.isClosed=!0};function K(){try{const s=JSON.parse(N.value);Array.isArray(s)?a.value.menu=s.map(e=>({name:e.name||"",price:e.price||0,description:e.description||"",image:null})):alert("JSON 格式錯誤，請確認為陣列格式")}catch{alert("無法解析 JSON")}}ae(g,async s=>{if(s)try{const e=new Uint8Array(await s.arrayBuffer()),l=Ve(e,{type:"array"}),r=l.Sheets[l.SheetNames[0]],k=x.sheet_to_json(r).map(n=>({name:n.name||n.菜名||n.品項||n.項目||"",price:n.price||n.價格||n.單價||0,description:n.description||n.描述||n.說明||"",image:null})).filter(n=>n.name||n.price);a.value.menu=F.value?a.value.menu.concat(k):k}catch(e){console.error("Excel 解析錯誤",e),alert("無法解析 Excel，請確認檔案內容是否正確")}finally{g.value=null}});function Q(){const s=[{name:"菜名範例",price:87,description:"描述範例"}],e=x.json_to_sheet(s),l=x.book_new();x.book_append_sheet(l,e,"菜單範本"),ce(l,"menu_template.xlsx")}const X=async()=>{var e,l;A.value=!0;const s=new FormData;s.append("name",a.value.name),s.append("phone",a.value.phone),s.append("address",a.value.address),s.append("link",a.value.link),s.append("category",a.value.category),s.append("delivery",a.value.delivery),s.append("delivery_price",a.value.delivery_price),s.append("delivery_number",a.value.delivery_number),s.append("order_time",a.value.order_time),s.append("sell",a.value.sell),s.append("tags",JSON.stringify(a.value.tags)),s.append("menu",JSON.stringify(a.value.menu.filter(r=>r.name&&r.price>0))),s.append("business_hours",JSON.stringify(a.value.business_hours)),a.value.image&&a.value.image.length>0&&s.append("image",a.value.image[0]),b.value&&s.append("menuImage",b.value);try{await E.update(_,s),S({text:"餐廳更新成功",snackbarProps:{color:"success"}}),P.push(`/restaurants/${_}`)}catch(r){console.error("更新餐廳失敗",r),S({text:((l=(e=r.response)==null?void 0:e.data)==null?void 0:l.message)||"更新失敗",snackbarProps:{color:"error"}})}finally{A.value=!1}};return(s,e)=>(p(),U(ye,null,{default:t(()=>[o(y,null,{default:t(()=>[o(d,{cols:"12"},{default:t(()=>e[16]||(e[16]=[V("h1",{class:"text-h4 mb-4"},"編輯餐廳",-1)])),_:1,__:[16]})]),_:1}),!w.value&&a.value.name?(p(),U(be,{key:0,onSubmit:se(X,["prevent"])},{default:t(()=>[o(te,{class:"pa-4"},{default:t(()=>[o(ue,null,{default:t(()=>e[17]||(e[17]=[m("📋 餐廳資訊",-1)])),_:1,__:[17]}),o(re,null,{default:t(()=>[o(C,{modelValue:a.value.image,"onUpdate:modelValue":e[0]||(e[0]=l=>a.value.image=l),accept:"image/*",clearable:"",label:"更換圖片"},null,8,["modelValue"]),o(i,{modelValue:a.value.name,"onUpdate:modelValue":e[1]||(e[1]=l=>a.value.name=l),label:"餐廳名稱",rules:[T.required]},null,8,["modelValue","rules"]),o(i,{modelValue:a.value.phone,"onUpdate:modelValue":e[2]||(e[2]=l=>a.value.phone=l),label:"餐廳電話",rules:[T.required]},null,8,["modelValue","rules"]),o(i,{modelValue:a.value.address,"onUpdate:modelValue":e[3]||(e[3]=l=>a.value.address=l),label:"餐廳地址"},null,8,["modelValue"]),o(i,{modelValue:a.value.link,"onUpdate:modelValue":e[4]||(e[4]=l=>a.value.link=l),label:"餐廳外部連結（GOOGLE、FB）"},null,8,["modelValue"]),o(j,{modelValue:a.value.category,"onUpdate:modelValue":e[5]||(e[5]=l=>a.value.category=l),items:["食物","飲料","其他"],label:"分類",rules:[T.required]},null,8,["modelValue","rules"]),o(ge,{modelValue:a.value.tags,"onUpdate:modelValue":e[6]||(e[6]=l=>a.value.tags=l),chips:"","closable-chips":"",items:O.value,label:"標籤 (輸入後按 Enter 新增)",multiple:""},null,8,["modelValue","items"]),o(D,{modelValue:a.value.delivery,"onUpdate:modelValue":e[7]||(e[7]=l=>a.value.delivery=l),color:"primary",label:"提供外送服務"},null,8,["modelValue"]),a.value.delivery?(p(),U(y,{key:0},{default:t(()=>[o(d,{cols:"6"},{default:t(()=>[o(i,{modelValue:a.value.delivery_price,"onUpdate:modelValue":e[8]||(e[8]=l=>a.value.delivery_price=l),modelModifiers:{number:!0},label:"外送最低金額",prefix:"$",type:"number"},null,8,["modelValue"])]),_:1}),o(d,{cols:"6"},{default:t(()=>[o(i,{modelValue:a.value.delivery_number,"onUpdate:modelValue":e[9]||(e[9]=l=>a.value.delivery_number=l),modelModifiers:{number:!0},label:"外送所需份數",suffix:"份",type:"number"},null,8,["modelValue"])]),_:1})]),_:1})):ne("",!0),o(i,{modelValue:a.value.order_time,"onUpdate:modelValue":e[10]||(e[10]=l=>a.value.order_time=l),label:"最後點餐時間"},null,8,["modelValue"]),o(D,{modelValue:a.value.sell,"onUpdate:modelValue":e[11]||(e[11]=l=>a.value.sell=l),color:"primary",label:"上架"},null,8,["modelValue"]),o(I,{class:"my-4"}),e[26]||(e[26]=V("h3",{class:"text-h6 mb-2"},"🕒 營業時間設定",-1)),V("div",Ue,[o(de,null,{default:t(()=>[o(v,{size:"small",onClick:R},{default:t(()=>e[18]||(e[18]=[m("全部營業",-1)])),_:1,__:[18]}),o(v,{size:"small",onClick:L},{default:t(()=>e[19]||(e[19]=[m("平日營業",-1)])),_:1,__:[19]}),o(v,{size:"small",onClick:H},{default:t(()=>e[20]||(e[20]=[m("全部休息",-1)])),_:1,__:[20]})]),_:1})]),(p(!0),f(J,null,M(a.value.business_hours,l=>(p(),f("div",{key:l.day,class:"mb-3"},[o(y,null,{default:t(()=>[o(d,{cols:"3"},{default:t(()=>[o(j,{modelValue:l.day,"onUpdate:modelValue":r=>l.day=r,density:"compact",items:W,label:"星期"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),o(d,{cols:"3"},{default:t(()=>[o(_e,{modelValue:l.isClosed,"onUpdate:modelValue":r=>l.isClosed=r,density:"compact","hide-details":"",label:"休息"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),o(d,{cols:"3"},{default:t(()=>[o(i,{modelValue:l.open,"onUpdate:modelValue":r=>l.open=r,density:"compact",disabled:l.isClosed,label:"開始時間",type:"time"},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1024),o(d,{cols:"3"},{default:t(()=>[o(i,{modelValue:l.close,"onUpdate:modelValue":r=>l.close=r,density:"compact",disabled:l.isClosed,label:"結束時間",type:"time"},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1024)]),_:2},1024)]))),128)),o(I,{class:"my-4"}),e[27]||(e[27]=V("h3",{class:"text-h6 mb-2"},"📦 快速新增菜單",-1)),o(C,{modelValue:b.value,"onUpdate:modelValue":e[12]||(e[12]=l=>b.value=l),accept:"image/png, image/jpeg",class:"mb-3",label:"整體菜單圖片（選填）","prepend-icon":"mdi-image","show-size":""},null,8,["modelValue"]),o(v,{class:"mb-3",color:"green darken-1",dark:"",elevation:"2",onClick:Q},{default:t(()=>[o(B,{left:""},{default:t(()=>e[21]||(e[21]=[m("mdi-download",-1)])),_:1,__:[21]}),e[22]||(e[22]=m(" 下載範本 Excel ",-1))]),_:1,__:[22]}),o(C,{modelValue:g.value,"onUpdate:modelValue":e[13]||(e[13]=l=>g.value=l),accept:".xlsx",label:"上傳 Excel（含欄位 name, price, description）","prepend-icon":"mdi-file-excel","show-size":""},null,8,["modelValue"]),o(D,{modelValue:F.value,"onUpdate:modelValue":e[14]||(e[14]=l=>F.value=l),class:"mb-4",inset:"",label:"匯入菜單時： 覆蓋（關閉） / 合併（開啟）"},null,8,["modelValue"]),o(ke,{modelValue:N.value,"onUpdate:modelValue":e[15]||(e[15]=l=>N.value=l),"auto-grow":"",label:"或貼上 JSON 陣列",placeholder:'[{"name": "咖哩飯", "price": 100, "description": "美味"}]',rows:"5"},null,8,["modelValue"]),o(v,{class:"mt-2 mb-6",color:"primary",onClick:K},{default:t(()=>e[23]||(e[23]=[m("📥 匯入 JSON",-1)])),_:1,__:[23]}),e[28]||(e[28]=V("h3",{class:"text-h6 mb-2"},"📝 菜單編輯",-1)),(p(!0),f(J,null,M(a.value.menu,(l,r)=>(p(),f("div",{key:r,class:"my-2"},[o(y,{align:"center",dense:"",style:{gap:"8px"}},{default:t(()=>[o(d,{cols:"2"},{default:t(()=>[o(C,{modelValue:l.image,"onUpdate:modelValue":u=>l.image=u,accept:"image/png, image/jpeg",density:"compact","hide-details":"",label:"項目圖片","prepend-icon":"mdi-image","show-size":""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),o(d,{cols:"3"},{default:t(()=>[o(i,{modelValue:l.name,"onUpdate:modelValue":u=>l.name=u,clearable:"",dense:"",label:"項目",placeholder:"請輸入菜名",rules:[u=>!!u||"必填"]},null,8,["modelValue","onUpdate:modelValue","rules"])]),_:2},1024),o(d,{cols:"2"},{default:t(()=>[o(i,{modelValue:l.price,"onUpdate:modelValue":u=>l.price=u,modelModifiers:{number:!0},clearable:"",dense:"",label:"價格",placeholder:"0",rules:[u=>u>=0||"價格不能小於 0"],type:"number"},null,8,["modelValue","onUpdate:modelValue","rules"])]),_:2},1024),o(d,{cols:"4"},{default:t(()=>[o(i,{modelValue:l.description,"onUpdate:modelValue":u=>l.description=u,clearable:"",dense:"",label:"描述",placeholder:"請輸入描述"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),o(d,{class:"d-flex justify-center",cols:"1"},{default:t(()=>[o(v,{color:"error",icon:"",small:"",title:"刪除",onClick:u=>G(r)},{default:t(()=>[o(B,null,{default:t(()=>e[24]||(e[24]=[m("mdi-delete",-1)])),_:1,__:[24]})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024),o(I)]))),128)),o(v,{color:"success",onClick:$},{default:t(()=>e[25]||(e[25]=[m("＋ 新增菜單項目",-1)])),_:1,__:[25]})]),_:1,__:[26,27,28]}),o(ie,null,{default:t(()=>[o(me),o(v,{color:"success",loading:A.value,type:"submit"},{default:t(()=>e[29]||(e[29]=[m("儲存變更",-1)])),_:1,__:[29]},8,["loading"]),o(v,{class:"ml-2",color:"grey",to:`/restaurants/${pe(_)}`},{default:t(()=>e[30]||(e[30]=[m("取消",-1)])),_:1,__:[30]},8,["to"])]),_:1})]),_:1})]),_:1})):(p(),U(y,{key:1},{default:t(()=>[o(d,{class:"text-center",cols:"12"},{default:t(()=>[w.value?(p(),f("div",xe,[o(ve,{color:"primary",indeterminate:""}),e[31]||(e[31]=V("p",{class:"mt-2"},"載入資料中...",-1))])):(p(),f("div",Ce,"找不到餐廳資料"))]),_:1})]),_:1}))]),_:1}))}},Le=Z(Se,[["__scopeId","data-v-9d99f178"]]);export{Le as default};
